# روز ۰۹: مقایسه تفاوت‌های فایل و نسخه

در فرآیند استفاده از هر نرم‌افزار کنترل نسخه، شما اغلب نیاز دارید سوابق تاریخی را مشاهده کرده و تفاوت‌های بین نسخه‌ها را مقایسه کنید. نحوه مقایسه در Git تمرکز اصلی این مقاله خواهد بود.

## آماده‌سازی دایرکتوری کاری

ما به سرعت یک مخزن Git و دایرکتوری کاری با دو فایل و دو رکورد تغییر نسخه از طریق دستورات زیر ایجاد می‌کنیم:

```
mkdir git-demo
cd git-demo
git init

echo 1 > a.txt
echo 2 > b.txt
git add .
git commit -m "Initial commit"

echo 3 > a.txt
echo 4 > b.txt
git add .
git commit -m "Update a.txt and b.txt to 3 and 4"
```

## مفاهیم پایه git diff

برای مقایسه تفاوت‌های بین دو نسخه در Git، معمولاً از دستور `git diff` استفاده می‌کنید. بیایید ابتدا یک دستور ساده را برای مقایسه تفاوت‌های بین دو نسخه اجرا کنیم:

۱. ابتدا `git log` را اجرا کنید تا اطلاعات نسخه را دریافت کنید و idهای دو شیء کامیت آخر را به دست آورید.
۲. دستور `git diff commit1 commit2` را برای مقایسه تفاوت‌های بین دو نسخه اجرا می‌کنیم، جایی که `commit1` باید نسخه قدیمی‌تر و `commit2` باید نسخه جدیدتر باشد.

مطابق شکل زیر:

![image](figures/09/01.png)

از خروجیِ اجرای `git diff` می‌توانیم یک نتیجه اجرایی بگیریم. از آنجایی که در این دو مخزن دو فایل داریم و هر دو در بین این دو نسخه تغییر کرده‌اند، دو بخش از نتایج "مقایسه تفاوت" را لیست می‌کند.

در شکل بالا می‌بینید که هر بخش با `diff --git` شروع می‌شود که نشان می‌دهد گیت در حال مقایسه کدام دو فایل است.

خط دوم `index 37bcc8b..d855592 100644` نشان‌دهنده "Header Line" زمانی است که گیت این مقایسه را انجام می‌دهد. ممکن است در اینجا چندین خط وجود داشته باشد و اطلاعات لزوماً فقط همین‌ها نباشند. بسیاری از اطلاعات اضافی درباره این مقایسه تفاوت در اینجا علامت‌گذاری خواهد شد. به عنوان مثال، خط ایندکس، دو id هشِ بعد از آن (`37bcc8b..d855592`) نشان‌دهنده idهای دو شیء blob در بخش ذخیره‌سازی اشیاء Git (object storage) هستند که برای مقایسه این دو شیء blob استفاده می‌شوند. عدد `100644` بعد از آن یک ویژگی git است، کمی شبیه به ویژگی‌های فایل در محیط لینوکس، مانند اعلام اینکه این یک فایل، دایرکتوری، قابل خواندن، قابل نوشتن، قابل اجرا و غیره است. در اینجا چند نمونه رایج از ویژگی‌های git آورده شده است:

```
0100000000000000 (040000): دایرکتوری
1000000110100100 (100644): فایل معمولی غیرقابل اجرا
1000000110110100 (100664): فایل معمولی غیرقابل اجرا قابل نوشتن توسط گروه
1000000111101101 (100755): فایل معمولی قابل اجرا
1010000000000000 (120000): لینک نمادین (Symbolic link)
1110000000000000 (160000): Gitlink
```

برای لینک‌های مرتبط، به رشته بحث زیر مراجعه کنید:

* [نحوه خواندن فیلد mode در خروجی git-ls-tree](https://stackoverflow.com/a/8347325/910074)

خط سوم `--- a/a.txt` نشان‌دهنده نسخه "قدیمی‌تر" از بین دو نسخه مقایسه شده است.

خط چهارم `+++ b/a.txt` نشان‌دهنده نسخه "جدیدتر" از بین دو نسخه مقایسه شده است.

خط پنجم `@@ -1 +1 @@` نشان‌دهنده کل تعداد خطوط در نسخه قدیم و نسخه جدید این فایل است. `-1` یعنی نسخه قدیم فقط ۱ خط دارد و `+1` یعنی نسخه جدید هم فقط ۱ خط دارد.

در نهایت، تمام محتوای تغییر یافته لیست می‌شود. در اینجا سه نمایش ممکن وجود دارد:

* شروع با علامت منفی `-` به این معنی است که این خط در فرآیند تغییر از نسخه قدیمی به نسخه جدید حذف شده است.
* شروع با علامت مثبت `+` به این معنی است که این خط در فرآیند تغییر از نسخه قدیمی به نسخه جدید اضافه شده است.
* شروع با یک کاراکتر فاصله (space)، به این معنی است که این خط در هر دو نسخه بدون هیچ تغییری ظاهر شده است.

این کار مقایسه تفاوت اولین شیء blob در این دو نسخه را تکمیل می‌کند، و سپس مقایسه تفاوت دومین شیء blob در آن نسخه و غیره را نمایش می‌دهد.

هنگام استفاده از `git diff` در Git، در واقع شیء درختی (tree object) واحد مقایسه است. ما از نمودار و ویدیو در [روز ۰۶: تجزیه ساختار داده Git - ساختار اشیاء] یاد گرفتیم که هر شیء کامیت در واقع شامل یک شیء درختی از دایرکتوری ریشه است. بنابراین وقتی همین الان از `git diff` برای مقایسه دو شیء کامیت استفاده کردیم، در واقع اشیاء درختی تحت آن اشیاء کامیت را مقایسه می‌کردیم و فرآیند مقایسه به صورت بازگشتی (recursively) به پایین ادامه خواهد یافت. از این موضوع، باید بتوانید حس کنید که مکانیزم مقایسه diff در Git بسیار قدرتمند است. شما می‌توانید به سرعت تغییرات بین هر دو نسخه‌ای را مقایسه کنید.

هنگام استفاده از دستور `git diff` عمدتاً سه منبع برای اشیاء درختی وجود دارد:

* اشیاء درختی موجود در تمام نمودارهای کامیت، به این معنی که هر شیء درختی در هر نسخه.
* ایندکس (Index)، نشان‌دهنده اطلاعات پس از ارسال وضعیت فایل به "پایگاه داده ایندکس". در واقع، اشیاء درختی در زمان استفاده از دستور `git add` ایجاد شده‌اند.
* دایرکتوری کاری فعلی شما، اگرچه تغییرات دایرکتوری کاری هنوز به اشیاء درختی تبدیل نشده‌اند، اما می‌توان از طریق `git diff` از آن‌ها استفاده کرد.

## چهار روش اصلی مقایسه

برای مقایسه هر دو نسخه از طریق دستور `git diff` معمولاً چهار کاربرد دستوری زیر وجود دارد:

۱. git diff

   بدون هیچ پارامتری، آنچه مقایسه می‌شود تفاوت بین "دایرکتوری کاری" (working directory) و "ایندکس" (index) است. این یک دستور بسیار پرکاربرد است زیرا قبل از اجرای دستور `git add .` می‌توانید ابتدا از `git diff` استفاده کنید تا ببینید چه چیزی را تغییر داده‌اید.

   **توجه**: در واقع، در فرآیند استفاده از کنترل نسخه Git، قبل از اجرای `git commit` واقعاً امکان اجرای چندین باره دستور `git add` برای تأیید اینکه کدام فایل‌ها به ایندکس اضافه شوند وجود دارد، و در نهایت در نسخه ثبت می‌شود.

۲. git diff commit

   اگر فقط یک id کامیت بعد از `git diff` اضافه کنید، آنچه مقایسه می‌شود "دایرکتوری کاری" و "شیء درختی در شیء کامیت مشخص شده" است.

   پرکاربردترین دستور `git diff HEAD` است زیرا این دستور به معنای مقایسه "دایرکتوری کاری" با "آخرین نسخه شاخه فعلی" می‌باشد. این روش مقایسه وضعیت "ایندکس" را مقایسه نخواهد کرد، بنابراین باید به وضوح تشخیص دهید که کدام منبع شیء درختی را مقایسه می‌کنید.

۳. git diff --cached commit

   قبل از اجرای `git commit` وضعیت ایندکس باید آماده باشد. بنابراین اگر می‌خواهید "وضعیت فعلی ایندکس" را با "شیء درختی در شیء کامیت مشخص شده" مقایسه کنید، می‌توانید از این دستور برای تکمیل کار مقایسه استفاده کنید.

   پرکاربردترین دستور نیز `git diff --cached HEAD` است، به این معنی که "وضعیت فعلی ایندکس" را با "آخرین نسخه شاخه فعلی" مقایسه می‌کند. این روش مقایسه، محتوای فایل "دایرکتوری کاری" را مقایسه نمی‌کند، بلکه مستقیماً تفاوت بین "ایندکس" و "آخرین نسخه فعلی" را مقایسه می‌کند. این به شما کمک می‌کند تا قبل از اجرای `git commit` متوجه شوید چه تغییراتی وجود دارد، یعنی چه تغییراتی را به عنوان یک نسخه ایجاد خواهید کرد.

   **نکته ۱**: خروجی `git diff --cached` و `git diff --staged` دقیقاً یکسان است. `--staged` فقط یک نام مستعار برای `--cached` است تا به خاطر سپردن آن برای شما آسان‌تر باشد!

   **نکته ۲**: اجرای `git diff --cached` و `git diff --cached HEAD` نیز دقیقاً یکسان است. در انتها می‌توان HEAD را حذف کرد.

۴. git diff commit1 commit2

   آخرین مورد مقایسه تفاوت بین دو نسخه مختلف (commit ids) است. این دستور می‌تواند هرگونه تغییری را در "ایندکس" و "دایرکتوری کاری" نادیده گرفته و مستقیماً دو نسخه خاص را مقایسه کند. در واقع Git اشیاء درختی را در آن دو شیء کامیتِ نسخه خاص مقایسه می‌کند.

   پرکاربردترین دستور `git diff HEAD^ HEAD` است، به این معنی که می‌خواهید تفاوت بین [نسخه قبلیِ آخرین نسخه] و [آخرین نسخه] را مقایسه کنید. معنای HEAD و ^ در مقالات آینده توضیح داده خواهد شد.

## خلاصه امروز

دستور `git diff` که امروز معرفی شد یک دستور بسیار پرکاربرد است و شما باید در استفاده از آن مهارت پیدا کنید. بیایید در نهایت تفاوت‌های بین دستورات پرکاربرد آن را مرور کنیم:

```
git diff                 => working directory vs index
git diff HEAD            => working directory vs HEAD
git diff --cached HEAD   => index     vs HEAD
git diff --cached        => index     vs HEAD
git diff HEAD^ HEAD     => HEAD^   vs HEAD
```

اجازه دهید دستورات گیت و پارامترهای یاد گرفته شده امروز را دوباره سازماندهی کنم:

* git log
* git diff
* git diff HEAD
* git diff --cached
* git diff --staged
* git diff HEAD^ HEAD

## لینک‌های مرجع

* [git-diff(1) Manual Page](https://www.kernel.org/pub/software/scm/git/docs/git-diff.html)

---

* [بازگشت به فهرست مطالب](README.md)
* [روز قبل: مفاهیم پایه و استفاده از شاخه‌ها (Branches)](08.md)
* [روز بعد: درک نام‌های مطلق اشیاء Git](10.md)

---
