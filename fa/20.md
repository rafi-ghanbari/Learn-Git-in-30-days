# روز ۲۰: اصلاح تاریخچه نسخه‌های ثبت شده - بخش ۲ (revert)

در فرآیند کنترل نسخه، موقعیت رایج دیگری وجود دارد: پس از انجام چندین Commit، متوجه می‌شوید که برخی از کامیت‌های قبلی اشتباه بوده‌اند. به عنوان مثال، شما به طور تصادفی کد تست را Commit کرده‌اید که باعث ایجاد مشکل در نسخه فعلی شده است. در این مورد، باید محتوای توضیح داده شده در این مقاله را درک کنید.

در روز ۱۸، ما در مورد `git reset` و `git commit --amend` برای اصلاح تاریخچه کامیت محلی یاد گرفتیم. با این حال، این دستورات تاریخچه را بازنویسی می‌کنند و نباید برای کامیت‌هایی که در مخازن مشترک Push شده‌اند، استفاده شوند. برای تاریخچه مشترک، `git revert` جایگزین ایمن است.

## درک git revert

`git revert` یک کامیت جدید ایجاد می‌کند که تغییرات یک کامیت قبلی را لغو می‌کند. برخلاف `reset` ، تاریخچه را بازنویسی نمی‌کند - بلکه به آن اضافه می‌کند. این موضوع آن را برای شاخه‌های مشترک ایمن می‌کند.

فرض کنید در این مرحله متوجه شوید که یک کامیت قبلی (مانند `~HEAD` یا `^HEAD` یا یک هش کامیت خاص) به اشتباه انجام شده است. شما می‌خواهید **فقط آن نسخه خاص** را بازگردانید، نه اینکه به نسخه اول ریست کنید و همه کارها را دوباره انجام دهید. در این مورد، می‌توانید دستور `git revert` را امتحان کنید که می‌تواند تغییرات یک نسخه خاص را از طریق مراحل "معکوس" خنثی کند.

"معکوس" به چه معناست؟ بیایید بلافاصله این دستور را امتحان کنیم.

**نکته مهم**: قبل از اجرای دستور `git revert` ، مطمئن شوید که دایرکتوری کاری شما تمیز است! اگر فایل‌هایی دارید که تا حدی تغییر کرده‌اند، توصیه می‌شود از `git stash` برای ایجاد یک استش موقت استفاده کنید.

## بازگرداندن پایه (Basic Revert)

برای بازگرداندن آخرین کامیت:

```
git revert HEAD
```

این کار یک کامیت جدید ایجاد می‌کند که تغییرات آخرین کامیت را خنثی می‌کند.

## بازگرداندن یک کامیت خاص (Reverting a Specific Commit)

فرض کنید از تاریخچه `git log` ، یک نسخه مشکل‌ساز پیدا کرده‌اید. ابتدا می‌توانید سوابق تغییر این نسخه را بررسی کنید. می‌توانید از `git log` برای پیدا کردن ID کامیت استفاده کنید، سپس از `git show [commit_id]` برای دیدن اطلاعات مربوط به آن نسخه استفاده کنید.

برای بازگرداندن یک کامیت خاص:

```
git revert <commit-hash>
```

به عنوان مثال:

```
git revert a1b2c3d
```

در حین اجرا، از شما خواسته می‌شود پیام کامیت نهایی را ویرایش کنید. به طور پیش‌فرض، کلمه `Revert` را اضافه می‌کند و همچنین در خط سوم عبارت `This reverts commit xxxx` را اضافه می‌کند تا به شما بگوید هدف اصلی این نسخه بازگشت از نسخه `xxxx` است.

## بازگرداندن چندین کامیت

برای بازگرداندن محدوده‌ای از کامیت‌ها:

```
# بازگرداندن کامیت‌ها از HEAD~3 تا HEAD~1 (3 کامیت)
git revert HEAD~3..HEAD
```

یا بازگرداندن چندین کامیت خاص:

```
git revert <hash1> <hash2> <hash3>
```

## بازگرداندن بدون کامیت کردن (Revert Without Committing)

برای آماده‌سازی تغییراتِ بازگشتی بدون Commit کردن خودکار:

```
git revert --no-commit HEAD
# یا
git revert -n HEAD
```

این مورد زمانی مفید است که بخواهید چندین کامیت را بازگردانید و یک کامیتِ بازگشتی واحد ایجاد کنید:

```
git revert --no-commit HEAD~3..HEAD
git commit -m "Revert last 3 commits"
```

## مدیریت تداخل‌ها (Handling Conflicts)

گاهی اوقات بازگرداندن یک کامیت می‌تواند باعث ایجاد تداخل شود:

```
git revert <commit-hash>
# اگر تداخل رخ دهد...
# ۱. تداخل‌ها را در فایل‌ها حل کنید
# ۲. فایل‌های حل شده را آماده (stage) کنید
git add <resolved-files>
# ۳. فرآیند بازگرداندن را ادامه دهید
git revert --continue
```

برای لغو یک فرآیند بازگرداندن در حال انجام:

```
git revert --abort
```

## بازگرداندن یک کامیت ادغام (Reverting a Merge Commit)

بازگرداندن یک ادغام پیچیده‌تر است زیرا یک کامیتِ ادغام دارای دو والد است. شما باید مشخص کنید به کدام والد بازگردید:

```
# -m 1 یعنی تغییرات والد اول را حفظ کن (معمولاً خط اصلی یا mainline)
git revert -m 1 <merge-commit-hash>
```

## چه زمانی از Revert در مقابل Reset استفاده کنیم

**از `git revert` استفاده کنید زمانی که:**
* کامیت در یک مخزن مشترک Push شده است.
* می‌خواهید تاریخچه را حفظ کنید.
* روی یک شاخه عمومی کار می‌کنید (مانند main، develop و غیره).
* نیاز به رکوردی از عملیات لغو (undo) دارید.

**از `git reset` استفاده کنید زمانی که:**
* کامیت فقط در مخزن محلی شماست.
* می‌خواهید کامیت‌ها را به طور کامل از تاریخچه حذف کنید.
* روی یک شاخه خصوصی (feature branch) کار می‌کنید.
* کامیت اشتباهی بود که نباید در تاریخچه باشد.

## بازگرداندن و اعمال مجدد تغییرات

گاهی اوقات یک کامیت را بازمی‌گردانید اما بعداً می‌خواهید دوباره آن را اعمال کنید:

```
# ابتدا، یک کامیت را بازگردانید
git revert <commit-hash>

# بعداً، بازگرداندن را بازگردانید!
git revert <revert-commit-hash>
```

## مثال‌های کاربردی

### مثال ۱: بازگرداندن یک کامیت بد در شاخه Main

```
# کامیت a1b2c3d باعث ایجاد باگ شده است
git revert a1b2c3d
git push origin main
```

### مثال ۲: بازگرداندن چندین کامیت

```
# بازگرداندن ۵ کامیت آخر به عنوان یک کامیتِ بازگشتی واحد
git revert --no-commit HEAD~5..HEAD
git commit -m "Revert last 5 commits due to critical bug"
git push origin main
```

### مثال ۳: بازگرداندن و انجام اصلاحات

```
# بازگرداندن یک کامیت مشکل‌ساز
git revert a1b2c3d

# انجام اصلاحات لازم
# ... ویرایش فایل‌ها ...

# ثبت اصلاحات
git add .
git commit -m "Fix issues from reverted commit"
git push origin main
```

## بهترین تجربه‌ها (Best Practices)

۱. **پیام‌های واضح بنویسید**: توضیح دهید چرا در حال بازگرداندن هستید.
   ```
   git revert a1b2c3d -m "Revert feature x due to performance issues"
   ```

۲. **قبل از Push تست کنید**: مطمئن شوید که بازگرداندن چیزی را خراب نمی‌کند.

۳. **ارتباط برقرار کنید**: وقتی کامیت‌ها را بازمی‌گردانید، به تیم خود اطلاع دهید.

۴. **گزینه‌های جایگزین را در نظر بگیرید**: گاهی اوقات یک اصلاحِ رو به جلو (forward fix) بهتر از بازگرداندن است.

۵. **دلیل را مستند کنید**: به شماره مسائل (issue numbers) ارجاع دهید یا زمینه کاری را ارائه دهید.

## مشاهده تاریخچه بازگرداندن

برای مشاهده کامیت‌های بازگشتی در تاریخچه خود:

```
git log --oneline --grep="Revert"
```

## خلاصه امروز

دستور `git revert` راه ایمن برای لغو تغییرات در مخازن مشترک است. این دستور در عین حال که تغییرات ناخواسته را خنثی می‌کند، یکپارچگی تاریخچه را نیز حفظ می‌کند. درک اینکه چه زمانی باید از `revert` در مقابل `reset` استفاده کرد، برای همکاری مؤثر و حفظ تاریخچه پروژه تمیز و قابل درک، بسیار حیاتی است.

اجازه دهید دستورات گیت و پارامترهای یاد گرفته شده امروز را دوباره سازماندهی کنم:

* git revert
* git revert HEAD
* git revert <commit-hash>
* git revert --no-commit
* git revert -n
* git revert -m
* git revert --continue
* git revert --abort

---

* [بازگشت به فهرست مطالب](README.md)
* [روز قبل: تنظیم لیست نادیده گرفتن .gitignore](19.md)
* [روز بعد: اصلاح تاریخچه نسخه‌های ثبت شده - بخش ۳ (cherry-pick)](21.md)

---
