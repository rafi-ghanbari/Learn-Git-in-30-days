# روز ۱۷: مفاهیم پایه و استفاده از ادغام (Merging)

همانطور که در روز ۰۸ (مفاهیم پایه و استفاده از شاخه‌ها) ذکر شد، ما در مورد "شاخه‌ها" یاد گرفتیم. اکنون در مورد نحوه انجام "ادغام" (merging) بحث خواهیم کرد. از آنجایی که Git یک سیستم کنترل نسخه توزیع شده (DVCS) است، شما دائماً عملیات شاخه‌سازی و ادغام را انجام خواهید داد، خواه ادغام عمدی (`git merge`) باشد یا ادغام ناخواسته (`git pull`). به طور خلاصه، عملیات "شاخه‌سازی" و "ادغام" واقعاً هنگام استفاده از Git برای کنترل نسخه به طور مکرر رخ می‌دهد. این مقاله مفاهیم پایه و نحوه استفاده از عملیات "ادغام" را توضیح می‌دهد.

## درک مفاهیم ادغام (Merging)

وقتی در یک دایرکتوری کاری Git شاخه‌ها را ایجاد می‌کنید، می‌توانید سیستم خود را بر اساس نیازهای مختلف به طور جداگانه و بدون تأثیر بر یکدیگر توسعه دهید. به عنوان مثال، می‌توانید سیستم اصلی و پایدار خود را در شاخه `master` برای توسعه نگه دارید و زمانی که نیاز به رفع خطاها دارید، یک شاخه اضافی `bugfix` برای تصحیح خطاهای نرم‌افزاری ایجاد کنید. پس از رفع باگ‌ها، می‌توانید تغییرات را از شاخه `bugfix` دوباره از طریق "ادغام" به `master` اعمال کنید. این یکی از سناریوهای اصلی استفاده است.

به طور کلی، همه روی یک شاخه اصلی یا پیش‌فرض (`master`) توسعه می‌دهند، سپس بر اساس نیازها شاخه‌هایی (`bugfix`) ایجاد می‌کنند و در نهایت دو شاخه را در یکی ادغام می‌کنند. در واقع، هنگام انجام عملیات "ادغام"، شما شاخه دیگری را در شاخه فعلی ادغام می‌کنید و سپس شاخه دیگر را به صورت دستی حذف می‌کنید. این با مفهوم "ادغام دو شاخه در یکی" مطابقت دارد.

در عمل، اغلب فرصت‌هایی برای ادغام سه، چهار یا تعداد بیشتری شاخه در یکی از آن‌ها وجود دارد. به عنوان مثال، علاوه بر شاخه اصلی (`master`)، شاخه‌ای برای اشکال‌زدایی (`bugfix`) و شاخه‌ای برای افزودن قابلیت‌ها (`feature`) نیز ایجاد می‌کنید. پس از توسعه تا حد معین، می‌توانید تصمیم بگیرید که آیا هر دوی این شاخه‌ها را با هم به شاخه اصلی (`master`) برگردانید یا خیر.

هنگام استفاده از ادغام در Git، یک مفهوم مهم وجود دارد: **عمل ادغام باید در همان مخزن (repository) رخ دهد**. به یاد داشته باشید که در هر مخزن Git، باید یک شیء Initial Commit (نسخه اولیه) وجود داشته باشد و تمام نسخه‌های دیگر با این نسخه مرتبط خواهند بود. ما به این رابطه "شیء ردیابی شده روی نوکِ شاخه‌ها" (the tracked object on the branch heads) می‌گوییم، بنابراین نمی‌توانید یک شاخه خاص از یک مخزن را در شاخه‌ای از مخزن کاملاً نامرتبط دیگری ادغام کنید.

هنگام ادغام، اگر دو شاخه فایل یکسانی را تغییر داده باشند، تا زمانی که خطوط تغییر یافته متفاوت باشند، Git به طور خودکار این دو تغییر را برای شما اعمال/ادغام می‌کند. اما اگر اتفاق بیفتد که "همان فایل" را در "همان خط" در هر دو شاخه تغییر داده باشید، در حین ادغام یک تداخل (conflict) رخ می‌دهد. هنگامی که یک تداخل ادغام رخ می‌دهد، Git هیچ تصمیمی برای شما نمی‌گیرد، بلکه کارِ "حل تداخل" را به "شما" واگذار می‌کند و این فایل‌های دارای تداخل همگی با وضعیت `unmerged` علامت‌گذاری می‌شوند. پس از یک تداخل ادغام، می‌توانید از دستور `git status` برای مشاهده این وضعیت‌ها استفاده کنید.

## انواع ادغام (Types of Merges)

به طور کلی دو نوع اصلی ادغام در Git وجود دارد:

۱. **Fast-forward merge**: زمانی استفاده می‌شود که شاخه هدف از شاخه منبع منحرف (diverged) نشده باشد.
۲. **Three-way merge**: زمانی استفاده می‌شود که هر دو شاخه دارای کامیت‌های جدید باشند.

## ادغام سریع (Fast-Forward Merge)

ادغام Fast-forward زمانی رخ می‌دهد که شاخه فعلی از شاخه‌ای که در حال ادغام است منحرف نشده باشد. Git به سادگی اشاره‌گر شاخه را به جلو حرکت می‌دهد.

```
# در شاخه master
git merge feature-branch
```

اگر شاخه `master` از زمان ایجاد `feature-branch` کامیت جدیدی نداشته باشد، Git یک ادغام fast-forward انجام می‌دهد.

## ادغام سه طرفه (Three-Way Merge)

زمانی که هر دو شاخه کامیت‌های جدیدی دارند، Git یک ادغام سه طرفه انجام می‌دهد و یک کامیت ادغام جدید ایجاد می‌کند که تغییرات هر دو شاخه را ترکیب می‌کند.

```
# در شاخه master
git merge feature-branch
```

این کار یک کامیت جدید با دو کامیت والد ایجاد می‌کند.

## جلوگیری از Fast-Forward

گاهی اوقات می‌خواهید تاریخچه شاخه را حتی زمانی که fast-forward ممکن است، حفظ کنید:

```
git merge --no-ff feature-branch
```

این دستور همیشه یک کامیت ادغام ایجاد می‌کند، حتی برای ادغام‌های fast-forward.

## تداخل‌های ادغام (Merge Conflicts)

تداخل زمانی رخ می‌دهد که همان خطوط در فایل‌های یکسان به طور متفاوتی در دو شاخه ادغام شده تغییر کرده باشند. وقتی این اتفاق می‌افتد:

۱. Git ادغام را متوقف می‌کند.
۲. فایل‌های دارای تداخل را علامت‌گذاری می‌کند.
۳. نشانگرهای تداخل (conflict markers) را به فایل‌ها اضافه می‌کند.
۴. منتظر می‌ماند تا شما تداخل‌ها را حل کنید.

## مشاهده فایل‌های دارای تداخل

برای اینکه ببینید کدام فایل‌ها تداخل دارند:

```
git status
```

فایل‌های دارای تداخل به عنوان "both modified" لیست می‌شوند.

## نشانگرهای تداخل (Conflict Markers)

گیت نشانگرهایی را به فایل‌های دارای تداخل اضافه می‌کند:

```
<<<<<<< HEAD
تغییرات شما
=======
تغییرات آن‌ها
>>>>>>> branch-name
```

* `<<<<<<< HEAD`: شروع تغییرات شما را نشان می‌دهد.
* `=======`: دو نسخه را از هم جدا می‌کند.
* `>>>>>>> branch-name`: پایان تغییرات ورودی را نشان می‌دهد.

## حل تداخل‌ها (Resolving Conflicts)

برای حل تداخل‌ها:

۱. فایل‌های دارای تداخل را باز کنید.
۲. به دنبال نشانگرهای تداخل بگردید.
۳. فایل را ویرایش کنید تا تداخل حل شود.
۴. نشانگرهای تداخل را حذف کنید.
۵. فایل‌های حل شده را آماده کنید: `git add <file>`
۶. ادغام را کامل کنید: `git commit`

## لغو یک ادغام (Aborting a Merge)

اگر می‌خواهید ادغام در حال انجام را لغو کنید:

```
git merge --abort
```

این کار مخزن شما را به حالتی که قبل از شروع ادغام بود باز می‌گرداند.

## مشاهده تاریخچه ادغام

برای مشاهده کامیت‌های ادغام در تاریخچه خود:

```
git log --oneline --graph --all
```

این دستور یک نمایش بصری از شاخه شما و تاریخچه ادغام را نشان می‌دهد.

## استراتژی‌های ادغام (Merge Strategies)

گیت از استراتژی‌های ادغام مختلفی پشتیبانی می‌کند:

* **recursive** (پیش‌فرض): استراتژی ادغام سه طرفه پیش‌فرض.
* **ours**: در تداخل‌ها همیشه نسخه ما را ترجیح بده.
* **theirs**: در تداخل‌ها همیشه نسخه آن‌ها را ترجیح بده.

```
git merge -X ours branch-name
git merge -X theirs branch-name
```

## بهترین تجربه‌ها (Best Practices)

۱. **کارهای خود را Commit کنید** قبل از ادغام.
۲. **آخرین تغییرات را Pull کنید** از مخزن راه دور قبل از ادغام.
۳. **ادغام را تست کنید** قبل از انتقال (push) به شاخه‌های مشترک.
۴. با تیم خود در مورد ادغام‌ها **ارتباط برقرار کنید**.
۵. در صورت امکان **ادغام‌ها را کوچک نگه دارید**.

## خلاصه امروز

ادغام یک عملیات اساسی در Git است که به شما امکان می‌دهد کارهای شاخه‌های مختلف را با هم ترکیب کنید. درک نحوه عملکرد ادغام‌ها، به ویژه نحوه مدیریت تداخل‌ها، برای همکاری مؤثر ضروری است. ادغام را به طور منظم تمرین کنید تا با این فرآیند راحت شوید.

اجازه دهید دستورات گیت و پارامترهای یاد گرفته شده امروز را دوباره سازماندهی کنم:

* git merge
* git merge --no-ff
* git merge --abort
* git merge -X ours
* git merge -X theirs
* git log --graph
* git status

---

* [بازگشت به فهرست مطالب](README.md)
* [روز قبل: استفاده از git reflog برای ردیابی تاریخچه تغییرات](16.md)
* [روز بعد: اصلاح تاریخچه نسخه‌های ثبت شده - بخش ۱ (reset و amend)](18.md)

---
